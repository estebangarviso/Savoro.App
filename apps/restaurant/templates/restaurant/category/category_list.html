{% extends "restaurant/fragments/base.html" %}
{% load static %}
{% load humanize %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/category-list.css' %}" />
{% endblock extra_css %}
{% block main-content %}
  {% csrf_token %}
  <div class="row">
    <div class="col s12">
      <a class="waves-effect waves-light btn right red darken-1 category-add-btn"
         href="{% url 'restaurant:category_create' %}">
        <i class="material-icons left">add</i>Nueva categoría
      </a>
    </div>
  </div>
  <!-- Filtros -->
  <div class="row">
    <div class="col s12">
      <div class="card-panel white-text category-filter-card">
        <h5>
          <i class="material-icons">filter_list</i>Buscar categorías
        </h5>
        <form method="get" id="categoryFilterForm">
          <div class="row category-filter-row">
            <div class="col s12 m8">
              <div class="input-field category-filter-input category-filter-input-wrapper category-filter-input-no-margin">
                <i class="material-icons prefix">search</i>
                <input type="text"
                       name="search"
                       id="categorySearch"
                       value="{{ search_query }}"
                       placeholder="Buscar por nombre de categoría" />
              </div>
            </div>
            <div class="col s12 m4 center-align">
              <button type="submit"
                      class="waves-effect waves-light btn category-filter-btn white red-text">
                <i class="material-icons left">search</i>Buscar
              </button>
              <a href="{% url 'restaurant:category_list' %}"
                 class="waves-effect waves-light btn category-filter-btn white red-text">
                <i class="material-icons left">clear</i>Limpiar
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% if not categories %}
    <div class="row">
      <div class="col s12">
        <div class="card-panel red lighten-1 white-text category-no-results">
          <i class="material-icons">category</i>
          <h4>No se encontraron categorías</h4>
          <p>
            {% if search_query %}
              Intenta ajustar tu búsqueda
            {% else %}
              No hay
              categorías registradas actualmente
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  {% else %}
    <!-- Contador de resultados -->
    <div class="row">
      <div class="col s12">
        <p class="grey-text text-darken-1">
          <i class="material-icons tiny">info</i>
          Mostrando {{ total_count }} categoría{{ total_count|pluralize }}
        </p>
      </div>
    </div>
    <!-- Grid de categorías -->
    <div class="row">
      {% for category_item in categories %}
        <div class="col s12 m6 l4">
          <div class="card category-card category-card-clickable" data-href="{% url 'restaurant:category_update' category_item.id %}">
            <div class="category-card-header deep-purple darken-2 white-text">
              <i class="material-icons category-card-icon">restaurant_menu</i>
              <h5 class="category-card-title">{{ category_item.name }}</h5>
              <a href="javascript:void(0);"
                 class="btn-floating btn-small red darken-1 delete-category-btn-floating delete-category-btn waves-effect waves-light"
                 data-category-id="{{ category_item.id }}"
                 data-category-name="{{ category_item.name }}"
                 data-has-dishes="{{ category_item.dish_count }}">
                  <i class="material-icons">delete</i>
              </a>
              <a href="{% url 'restaurant:category_update' category_item.id %}"
                 class="btn-floating btn-small orange darken-1 edit-category-btn-floating waves-effect waves-light">
                  <i class="material-icons">edit</i>
              </a>
            </div>
            <div class="category-card-content">
              <div class="category-stats">
                <div class="category-stat">
                  <span class="category-stat-value deep-purple-text">{{ category_item.dish_count }}</span>
                  <span class="category-stat-label grey-text text-darken-1">Plato{{ category_item.dish_count|pluralize }}</span>
                </div>
              </div>
              <div class="category-meta grey-text text-darken-2">
                <i class="material-icons grey-text">access_time</i>
                <strong>Creado:</strong> {{ category_item.created_at|naturaltime }}
              </div>
              <div class="category-meta grey-text text-darken-2">
                <i class="material-icons grey-text">update</i>
                <strong>Actualizado:</strong> {{ category_item.updated_at|naturaltime }}
              </div>
              <div>
                <span class="category-status-badge {% if category_item.is_active %}green white-text category-status-active{% else %}red white-text category-status-inactive{% endif %}">
                  {% if category_item.is_active %}
                    <i class="material-icons tiny">check_circle</i> Activa
                  {% else %}
                    <i class="material-icons tiny">cancel</i> Inactiva
                  {% endif %}
                </span>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
  <!-- Modal de confirmación de eliminación -->
  <div id="deleteCategoryModal" class="modal">
    <div class="modal-content">
      <h4 class="red-text">
        <i class="material-icons left">warning</i>Confirmar eliminación
      </h4>
      <p>
        ¿Estás seguro de que deseas eliminar la categoría
        <strong id="categoryNameToDelete"></strong>?
      </p>
      <p class="grey-text" id="categoryWarning"></p>
    </div>
    <div class="modal-footer">
      <a href="#!" class="modal-close waves-effect waves-light btn-flat">Cancelar</a>
      <a href="#!"
         class="waves-effect waves-light btn red darken-1"
         id="confirmDeleteBtn">
        <i class="material-icons left">delete</i>Eliminar
      </a>
    </div>
  </div>
{% endblock main-content %}
{% block extra_js %}
  <script src="{% static 'js/category-filters.js' %}"></script>
  <script>
  document.addEventListener('DOMContentLoaded', function () {
      // Initialize modals
      const modalElems = document.querySelectorAll('.modal');
      const instances = M.Modal.init(modalElems);

      let categoryToDelete = null;
      const deleteCategoryModal = document.getElementById('deleteCategoryModal');
      const modal = M.Modal.getInstance(deleteCategoryModal);

      // Make category cards clickable
      document.querySelectorAll('.category-card-clickable').forEach(card => {
          card.addEventListener('click', function (e) {
              // Don't navigate if clicking on action buttons
              if (!e.target.closest('.delete-category-btn') && 
                  !e.target.closest('.edit-category-btn-floating') &&
                  !e.target.closest('.btn-floating')) {
                  window.location.href = this.dataset.href;
              }
          });
      });

      // Prevent edit button from triggering card click
      document.querySelectorAll('.edit-category-btn-floating').forEach(btn => {
          btn.addEventListener('click', function (e) {
              e.stopPropagation();
          });
      });

      // Handle delete button clicks
      const deleteButtons = document.querySelectorAll('.delete-category-btn');
      console.log('Delete buttons', deleteButtons);
      deleteButtons.forEach(btn => {
          btn.addEventListener('click', function (e) {
              e.preventDefault();
              e.stopPropagation();
              categoryToDelete = {
                  id: this.dataset.categoryId,
                  name: this.dataset.categoryName,
                  hasDishes: parseInt(this.dataset.hasDishes) > 0
              };

              document.getElementById('categoryNameToDelete').textContent = categoryToDelete.name;

              if (categoryToDelete.hasDishes) {
                  document.getElementById('categoryWarning').innerHTML =
                      '<i class="material-icons tiny left red-text">warning</i>Esta categoría tiene ' +
                      this.dataset.hasDishes + ' plato(s) asociado(s). No podrá ser eliminada.';
              } else {
                  document.getElementById('categoryWarning').textContent =
                      'Esta acción marcará la categoría como eliminada.';
              }

              modal.open();
          });
      });

      // Handle confirm delete
      document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
          if (!categoryToDelete) return;

          // Get CSRF token
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          // Send DELETE request
          fetch(`/categories/${categoryToDelete.id}/delete/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': csrftoken,
                  'Content-Type': 'application/json',
              },
          })
              .then(response => response.json())
              .then(data => {
                  modal.close();

                  if (data.success) {
                      // Show success toast
                      M.toast({
                          html: '<i class="material-icons left">check_circle</i>' + data.message,
                          classes: 'green darken-1',
                          displayLength: 4000
                      });

                      // Remove the category card from DOM
                      const categoryCard = document.querySelector(`[data-category-id="${categoryToDelete.id}"]`).closest('.col');
                      if (categoryCard) {
                          categoryCard.style.opacity = '0';
                          setTimeout(() => categoryCard.remove(), 300);
                      }
                  } else {
                      // Show error toast
                      M.toast({
                          html: '<i class="material-icons left">error</i>' + data.message,
                          classes: 'red darken-1',
                          displayLength: 5000
                      });
                  }

                  categoryToDelete = null;
              })
              .catch(error => {
                  modal.close();
                  M.toast({
                      html: '<i class="material-icons left">error</i>Error al eliminar la categoría',
                      classes: 'red darken-1',
                      displayLength: 5000
                  });
                  console.error('Error:', error);
              });
      });
  });

  // Display Django messages as Materialize toasts
  {% if messages %}
  {% for message in messages %}
  {% if message.tags == 'error' %}
  M.toast({
      html: '<i class="material-icons left">error</i>{{ message|escapejs }}',
      classes: 'red darken-1',
      displayLength: 5000
  });
  {% elif message.tags == 'success' %}
  M.toast({
      html: '<i class="material-icons left">check_circle</i>{{ message|escapejs }}',
      classes: 'green darken-1',
      displayLength: 4000
  });
  {% elif message.tags == 'warning' %}
  M.toast({
      html: '<i class="material-icons left">warning</i>{{ message|escapejs }}',
      classes: 'orange darken-1',
      displayLength: 4000
  });
  {% else %}
  M.toast({
      html: '<i class="material-icons left">info</i>{{ message|escapejs }}',
      classes: 'blue darken-1',
      displayLength: 4000
  });
  {% endif %}
  {% endfor %}
  {% endif %}
  </script>
{% endblock extra_js %}
